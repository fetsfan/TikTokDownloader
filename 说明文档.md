# 说明文档

## 项目规划
- 项目名称：DouK-Downloader（抖音/TikTok 下载器）
- 运行环境：`Windows 11`（TRAE 开发环境）
- 目标：提供稳定的下载与接口访问能力，支持 CLI/TUI/Web 等模式。
- 版本：当前启动显示 `DouK-Downloader V5.8 Beta`。

## 实施方案
- 采用顺序化思考拆解问题并执行闭环（ToDoList 管理）。
- 优先修复启动阻塞的语法错误；运行验证；记录结果；不影响既有功能与结构。
- 修复点以最小改动为原则，保持代码风格一致。

## 进度记录
- 2025-11-06 修复启动报错（多处 f-string 语法问题）并验证启动：
  - 修复 `src/config/parameter.py` 中 TikTok `ttwid` 拼接的跨行 f-string（改为单行）。
  - 修复 `src/custom/internal.py` 中 `PROJECT_NAME` 的跨行 f-string（改为单行）。
  - 修复 `src/interface/template.py` 中 `X-Bogus` 参数拼接的跨行 f-string（改为单行）。
  - 修复 `src/interface/info.py` 中嵌套 f-string 导致的未闭合问题（改为字符串拼接）。
  - 修复 `src/module/ffmpeg.py` 中 macOS 终端脚本的 f-string 反斜杠表达式（提取为变量）。
  - 修复 `src/module/ffmpeg.py` 中 `which(Path)` 类型问题（转换为 `str(path)`）。
  - 修复 `src/manager/recorder.py` 中跨行 f-string（改为单行）。
  - 运行验证：程序成功进入交互界面，提示 Cookie 未设置并允许模式选择，已正常退出。

- 2025-11-06 增强令牌校验：
  - 更新 `src/custom/function.py` 的 `is_valid_token(token)` 读取环境变量 `DOUK_TOKEN`。
  - 未设置 `DOUK_TOKEN` 时默认放行（返回 True），设置后需请求头 `token` 与其一致。
  - 使用方法（Windows PowerShell）：
    - 当前会话：`$env:DOUK_TOKEN = "your-secret-token"`
    - 永久设置：`setx DOUK_TOKEN "your-secret-token"`（重开终端生效）
  - 接口测试：调用 `GET /token` 并携带请求头 `token: your-secret-token`，返回“验证成功”。

- 2025-11-07 Docker 部署整理：去掉 `uv` 并修复 Dockerfile
  - 重写 `Dockerfile`，删除重复段与损坏的代码块，统一使用 `CMD ["python", "main.py"]`。
  - 预置 `/app/Volume/settings.json` 为 `{"run_command": "7"}`，容器启动直接进入 Web API 模式。
  - 预置数据库 `/app/Volume/DouK-Downloader.db`：`Disclaimer=1`、`Language='zh_CN'`，跳过首次交互。
  - 保留 `EXPOSE 5555` 与 `VOLUME /app/Volume`，监听 `0.0.0.0:5555`。
  - 部署（Zeabur）指引：
    - 根目录：填写 `/`（仓库根已有 `Dockerfile`）。
    - 环境变量：建议设置 `DOUK_TOKEN=强随机值`（公开部署必设）。
    - 存储：挂载持久化路径到容器 `/app/Volume`（务必填写此路径）。
    - 健康检查：可使用 `GET /docs` 或 `GET /token`（如设置令牌需在请求头传 `token`）。
    - 端口：服务固定监听 `5555`，如平台需指定端口，请配置为 `5555`。

- 2025-11-07 运行时初始化（避免挂载卷覆盖导致首次交互）
  - 新增 `docker_entry.py` 作为入口：启动前在 `/app/Volume` 初始化 `settings.json` 与数据库。
  - 更新 `Dockerfile` 使用 `CMD ["python", "docker_entry.py"]`，保证挂载卷内有数据后再启动。
  - 作用：即使 Zeabur 挂载了空卷，仍能自动写入 `Disclaimer=1` 与 `Language='zh_CN'`，避免弹出“请选择语言/免责声明”并导致容器重启。

- 2025-11-07 API-only 模式（移除交互，仅保留 Web API）
  - 新增 `api_main.py`：直接启动 FastAPI，仅走 Web API 流程，不进入语言选择、免责声明或主菜单。
  - 调整 `docker_entry.py`：初始化后改为执行 `api_main.py`（而非 `main.py`）。
  - 修复部署：`Dockerfile` 增加 `COPY api_main.py /app/api_main.py`，避免容器启动报错 `can't open file '/app/api_main.py'`。
  - 行为变更：容器启动即监听 `0.0.0.0:5555`，所有交互式提示被完全跳过。
  - 端口覆盖：支持平台通过环境变量 `PORT` 覆盖监听端口（默认 `5555`）。
  - 部署要点：挂载目录必须为 `/app/Volume`；建议设置 `DOUK_TOKEN` 以启用接口鉴权。

备注：后续如需扩展功能或调整计划，需先更新本说明文档中的“项目规划/实施方案”，再执行开发，并在“进度记录”中标记完成与说明结果。